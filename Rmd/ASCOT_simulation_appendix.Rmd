---
title: "ASCOT ADAPT Trial Simulation Report"
subtitle: "Version 0.1"
date: "July 2020"
output: 
  bookdown::pdf_document2:
    toc: true
    fig_align: center
    fig_height: 4
    fig_width: 6
    latex_engine: xelatex
header-includes:
  - \usepackage{blkarray}
  - \usepackage{pdflscape}
  - \usepackage{lastpage}
  - \usepackage{vhistory}
  - \usepackage{titling}
  - \pretitle{\begin{center}
    \includegraphics[width=2in,height=2in]{../image.jpg}\LARGE\\}
  - \posttitle{\end{center}}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \fancyhead[LO]{ASCOT ADAPT Simulation Report}
  - \fancyfoot[LO]{Version 0.1, July, 2020}
  - \fancyfoot[RO]{\thepage\ of \pageref{LastPage}}
  - \renewcommand{\headrulewidth}{0pt}
  - \renewcommand{\footrulewidth}{0pt}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```


```{r pkgs}
library(ascotsims)
library(tidyverse)
library(magrittr)
library(kableExtra)

theme_set(theme_bw(base_size = 9) +
            theme(panel.grid.minor = element_blank(),
                  legend.key.height = unit(0.1, "lines")))

cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbp2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```


# Version History {-}


```{=latex}
\begin{center}
    \begin{tabular}{lllp{5cm}}
    \hline
    Version & Date & Author & Description \\ \hline
    0.1 & July 2020 & JT & Draft outline \\ 
    \hline
    \end{tabular}
\end{center}
```

\clearpage


# Introduction

This document is an appendix to the ASCOT ADAPT trial core protocol. 
It details the technical details of the clinical trial simulations and results used in planning the ASCOT ADAPT trial decision thresholds. 
The simulations are used to understand the operating characteristics of the platform trial under various design configurations.
For full details of the analysis plan refer to the Statistical Analysis appendix.

\clearpage

# Simulation Design

## Model

The primary endpoint in the trial is death from any cause or requirement of new intensive respiratory support (invasive or non-invasive ventilation) or vasopressor/inotropic support in the 28 days after randomisation. 
This endpoint is binary and in these simulations a participants response is coded as 1 if they died or required new intensive respiratory support or vasopressor/inotropic support ventilation-free to 28 days and is 0 if they did not. 
Therefore, a beneficial treatment is one which reduces the probability of response.
The outcome is modelled by logistic regression and treatment effects are expressed in terms of their reduction in the log-odds of the outcome.

### Domains

For the purposes of this simulation document, 3 domains have been considered.
To make the document generalisable, these domains and the comprising treatments are not explicitly denoted, but are treated as generic.

The generic domains considered are labelled:

  * Domain $A$, consisting of 6 treatment combinations $A_0.A_1,A_2,A_3,A_4,A_5 = A_1+A_2$. Treatment $A_0$ is the absence of any treatment from domain $A$ (standard of care) and treatment $A_5$ is the combination of treatments $A_1$ and $A_2$ within the domain.
  * Domain $B$, consisting of 4 treatments $B_0,B_1,B_2,B_3$. Treatment $B_0$ is the absence of any domain $B$ treatment.
  * Domain $C$, consisting of 2 treatments $C_0,C_1$.

A regimen is a combination of one treatment option from each domain.
Every participant receives one regimen.
The number of unique regimens in these simulations, assuming all combinations are viable, is $6\times 4\times 2=48$.

The model used in these simulations are, for a given participant $i$
$$
\begin{aligned}
\eta_i &= \beta_0 + x_{A(i)}^{\mathsf{T}}\beta_A + x_{B(i)}^{\mathsf{T}}\beta_B + x_{C(i)}^{\mathsf{T}}\beta_C \\
\pi_i &= \text{logit}^{-1}(\eta_i)
\end{aligned}, \quad i=1,2,3,...
$$
where $\eta_i$ is there participants linear predictor as given by the combination of treatments they receive and $\pi_i$ is the participants probability of ventilation-free survival by 28 days after enrolment.

The vectors, e.g. $x_{A(i)}$, select the relevant parameters from $\beta_A$, for example if participant $i$ receives treatment $A_5$ then $x_{A(i)}^{\mathsf{T}} = (0\ 1\ 1\ 0\ 0\ 1)$ where $\beta_{A1}$ is the effect of treatment $A_1$ alone, $\beta_{A2}$ is the effect of $A_2$ alone, and $\beta_{A5}$ is the interaction effect between $A_1$ and $A_2$ when given in combination. 
This complete set of treatment option within a domain is expressed by the design matrix.
For example, domain $A$ has design
$$
 X_{A} = 
\begin{blockarray}{ccccccc}
          & \beta_{A0} & \beta_{A1} & \beta_{A2} & \beta_{A3} & \beta_{A4} & \beta_{A5} \\
\begin{block}{r(cccccc)}
      A_0 & 1 & 0 & 0 & 0 & 0 & 0 \\
      A_1 & 0 & 1 & 0 & 0 & 0 & 0 \\
      A_2 & 0 & 0 & 1 & 0 & 0 & 0 \\
      A_3 & 0 & 0 & 0 & 1 & 0 & 0 \\
      A_4 & 0 & 0 & 0 & 0 & 1 & 0 \\
      A_5 & 0 & 1 & 1 & 0 & 0 & 1 \\
\end{block}
\end{blockarray}
$$
and the notation $A(i)$ indicates which row of the design matrix $X_A$ applies for participant $i$.

The current model does not allow for interactions between separate domains, all treatment effects within domains are therefore assumed to be additive in combination.

### Prior

The prior distributions for the parameters are
$$
\begin{aligned}
\beta_0 &\sim N(0, 10^2) \\
\beta_{A0},\beta_{B0},\beta_{C0} &= 0 \\
\beta_{A1},...,\beta_{A5},\beta_{B1},...,\beta_{B3},\beta_{C1} &\sim N(0, 1).
\end{aligned}
$$
For identifiability, the effect of receiving $A_0$,$B_0$ and $C_0$ are set to zero implying that $\beta_0$ is the log-odds of response when no treatments are received in any domain (standard of care).

### Model Quantities

For the purpose of decision making, expected response under each regimen is of primary interest. 
Define
$$
\begin{aligned}
\eta_j &= \beta_0 + x_{A(j)}^{\mathsf{T}}\beta_A + x_{B(j)}^{\mathsf{T}}\beta_B + x_{C(j)}^{\mathsf{T}}\beta_C \\
\pi_j &= \text{logit}^{-1}(\eta_j)
\end{aligned},\quad j=1,...,48
$$
to be the log-odds and probability of response under regimen $j$. 
As before, the notation $A(j)\in\{0,1,2,3,4,5\}$ indicates which combination of domain $A$ treatments forms regimen $j$.

The parameters of primary interest are the treatment effects relative to no treatment (or another treatment within the domain) and the best treatment within each domain.

In what follows, all probabilities are implicitly conditional on the model and available data at the time of the analysis.

**Best Regimen**

Define $j^\star = \text{argmin}_j \eta_j$ to be the regimen which minimises the log-odds of response.
The probability that regimen $j$ is the best regimen (in terms of minimising the log-odds of response) is
$$
\mathbb P[\text{regimen }j\text{ is best}] = \mathbb P[j^\star = j] = \mathbb P[\eta_j < \eta_{l}, l\ne j],\quad j=1,...,48.
$$

**Best Treatment**

Define the probability that a treatment combination within each domain $A$, $B$, and $C$ is in the best regimen by
$$
\begin{aligned}
\mathbb P[\text{treatment }A_k\text{ is in best}] = \mathbb P[A(j^\star)=k],&\quad k=0,1,2,3,4,5 \\
\mathbb P[\text{treatment }B_k\text{ is in best}] = \mathbb P[B(j^\star)=k],&\quad k=0,1,2,3 \\
\mathbb P[\text{treatment }C_k\text{ is in best}] = \mathbb P[C(j^\star)=k],&\quad k=0,1
\end{aligned}.
$$

**Treatment Comparisons**

Define the probability that a treatment combination has a lower log-odds of the outcome than another treatment combination combination by
$$
\begin{aligned}
\mathbb P[\text{treatment }A_k\text{ better than treatment } A_l] &=\mathbb P\left[x_{A(k)}^{\mathsf{T}}\beta_A < x_{A(l)}^{\mathsf{T}}\beta_A\right],\quad k,l\in\{0,1,2,3,4,5\} \\
\mathbb P[\text{treatment }B_k\text{ better than treatment } B_l] &=\mathbb P\left[x_{B(k)}^{\mathsf{T}}\beta_B < x_{B(l)}^{\mathsf{T}}\beta_B\right],\quad k,l\in\{0,1,2,3\} \\
\mathbb P[\text{treatment }C_k\text{ better than treatment } C_l] &=\mathbb P\left[x_{C(k)}^{\mathsf{T}}\beta_C < x_{C(l)}^{\mathsf{T}}\beta_C\right],\quad k,l\in\{0,1\}
\end{aligned}
$$

For example, the probability that treatment $A_5$ reduces the log-odds of response compared to $A_0$ is
$$
\mathbb P[\text{treatment } A_5\text{ better than treatment } A_0] = \mathbb P[\beta_{A1}+\beta_{A2}+\beta_{A5}<0]
$$
and the probability that treatment $A_5$ reduces the log-odds of the response compared to $A_1$ is
$$
\mathbb P[\text{treatment } A_5\text{ better than treatment } A_1] = \mathbb P[\beta_{A2}+\beta_{A5}<0].
$$

## Decisions and Adaptations

A variety of trial decisions and adaptations may be possible as the trial progresses, for example, dropping the no treatment option within a domain if at least one treatment is found effective (reduces the log-odds of response compared to no treatment), or dropping all other treatment options if one treatment is found superior to all others (results in the lowest log-odds of response amongst all treatments).

Example decisions and their definitions are provided in Table \@ref(tab:dectab).
These example decisions are presented for a single treatment, $A_5$.
Not all decisions will be defined or of interest for all treatment combinations and these examples are indicative only.
Some of the treatments overlap and some definitions are redundant in that they can be defined in terms of other decisions (e.g. harm is contained in futility and inferiority is the complement of superiority).

```{r dectab}
tab <- tribble(
  ~ Decision, ~ Comparison, ~ Quantity, ~Threshold, ~Action,
  "$A_5$ is effective", "$A_5$ vs $A_0$", "$\\mathbb P[\\beta_{A1}+\\beta_{A2}+\\beta_{A5}<0]$", "0.99", "Drop $A_0$",
  "$A_5$ is harmful", "$A_5$ vs $A_0$", "$\\mathbb P[\\beta_{A1}+\\beta_{A2}+\\beta_{A5}>0]$", "0.99", "Drop $A_5$",
  "$A_5$ is futile", "$A_5$ vs $A_0$", "$\\mathbb P[\\beta_{A1}+\\beta_{A2}+\\beta_{A5}>-\\Delta]$", "0.95", "Drop $A_5$",
  "$A_5$ is equivalent", "$A_5$ vs $A_0$", "$\\mathbb P[|\\beta_{A1}+\\beta_{A2}+\\beta_{A5}|<\\Delta]$", "0.90", "Drop $A_5$",
  "$A_5$ is futile", "$A_5$ vs $A_1$", "$\\mathbb P[\\beta_{A2}+\\beta_{A5}>-\\Delta]$", "0.95", "Drop $A_5$",
  "$A_5$ is futile", "$A_5$ vs $A_2$", "$\\mathbb P[\\beta_{A1}+\\beta_{A5}>-\\Delta]$", "0.95", "Drop $A_5$",
  "$A_5$ is superior", "$A_5$ vs all $A$", "$\\mathbb P[A(j^\\star)=5]$", "0.99", "Drop all $A$ except $A_5$",
  "$A_5$ is inferior", "$A_5$ vs all $A$", "$\\mathbb P[A(j^\\star)\\ne5]$", "0.99", "Drop $A_5$"
)
kable(tab, booktabs = T, escape = F, linesep = "",
      caption = "Example trial decisions and definitions.") %>%
  kable_styling(latex_options = "HOLD_position")
```

For completeness, the actual decisions and thresholds used in the trial simulations for domain $A$ are given in Table \@ref(tab:simdectab).
The decisions for domains $B$ and $C$ are similar except for the absence of the extra futility check for a combination treatment.

```{r simdectab}
tab <- tribble(
  ~ Decision, ~ Comparison, ~ Quantity, ~Threshold, ~Action,
  "$A_1$ is effective", "$A_1$ vs $A_0$", "$\\mathbb P[\\beta_{A1}<0]$", "$>0.99$", "Drop $A_0$",
  "$A_2$ is effective", "$A_2$ vs $A_0$", "$\\mathbb P[\\beta_{A2}<0]$", "$>0.99$", "Drop $A_0$",
  "$A_3$ is effective", "$A_3$ vs $A_0$", "$\\mathbb P[\\beta_{A3}<0]$", "$>0.99$", "Drop $A_0$",
  "$A_4$ is effective", "$A_4$ vs $A_0$", "$\\mathbb P[\\beta_{A4}<0]$", "$>0.99$", "Drop $A_0$",
  "$A_5$ is effective", "$A_5$ vs $A_0$", "$\\mathbb P[\\beta_{A1}+\\beta_{A2}+\\beta_{A5}<0]$", "$>0.99$", "Drop $A_0$",
  "$A_1$ is futile", "$A_1$ vs $A_0$", "$\\mathbb P[\\beta_{A1}>-\\Delta]$", "$>0.95$", "Drop $A_1$",
  "$A_2$ is futile", "$A_2$ vs $A_0$", "$\\mathbb P[\\beta_{A2}>-\\Delta]$", "$>0.95$", "Drop $A_2$",
  "$A_3$ is futile", "$A_3$ vs $A_0$", "$\\mathbb P[\\beta_{A3}>-\\Delta]$", "$>0.95$", "Drop $A_3$",
  "$A_4$ is futile", "$A_4$ vs $A_0$", "$\\mathbb P[\\beta_{A4}>-\\Delta]$", "$>0.95$", "Drop $A_4$",
  "$A_5$ is futile", "$A_5$ vs $A_0$", "$\\mathbb P[\\beta_{A1}+\\beta_{A2}+\\beta_{A5}>-\\Delta]$", "$>0.95$", "Drop $A_5$",
  "$A_5$ is futile", "$A_5$ vs $A_1$", "$\\mathbb P[\\beta_{A2}+\\beta_{A5}>-\\Delta]$", "$>0.95$", "Drop $A_5$",
  "$A_5$ is futile", "$A_5$ vs $A_2$", "$\\mathbb P[\\beta_{A1}+\\beta_{A5}>-\\Delta]$", "$>0.95$", "Drop $A_5$",
  "$A_1$ is superior", "$A_1$ vs all $A$", "$\\mathbb P[A(j^\\star)=1]$", "$>0.99$", "Drop all but $A_1$",
  "$A_2$ is superior", "$A_2$ vs all $A$", "$\\mathbb P[A(j^\\star)=2]$", "$>0.99$", "Drop all but $A_2$",
  "$A_3$ is superior", "$A_3$ vs all $A$", "$\\mathbb P[A(j^\\star)=3]$", "$>0.99$", "Drop all but $A_3$",
  "$A_4$ is superior", "$A_4$ vs all $A$", "$\\mathbb P[A(j^\\star)=4]$", "$>0.99$", "Drop all but $A_4$",
  "$A_5$ is superior", "$A_5$ vs all $A$", "$\\mathbb P[A(j^\\star)=5]$", "$>0.99$", "Drop all but $A_5$",
    "$A_1$ is inferior", "$A_1$ vs all $A$", "$\\mathbb P[A(j^\\star)=1]$", "$<0.01/5$", "Drop $A_1$",
  "$A_2$ is inferior", "$A_2$ vs all $A$", "$\\mathbb P[A(j^\\star)=2]$", "$<0.01/5$", "Drop $A_2$",
  "$A_3$ is inferior", "$A_3$ vs all $A$", "$\\mathbb P[A(j^\\star)=3]$", "$<0.01/5$", "Drop $A_3$",
  "$A_4$ is inferior", "$A_4$ vs all $A$", "$\\mathbb P[A(j^\\star)=4]$", "$<0.01/5$", "Drop $A_4$",
  "$A_5$ is inferior", "$A_5$ vs all $A$", "$\\mathbb P[A(j^\\star)=5]$", "$<0.01/5$", "Drop $A_5$"
)
kable(tab, booktabs = T, escape = F, linesep = "",
      caption = "Simulation trial decisions and thresholds $(\\Delta = \\ln(1.1))$") %>%
  kable_styling(latex_options = "HOLD_position")
```


## Simulation Assumptions

The following assumptions are made for the purpose of simulation:

  * all combinations of treatment are allowed and all participants are eligible for all treatment combinations.
  * there are no interactions between treatment effects.
  * additional covariates to be included in the full model separate from the effect of treatment have not been included (e.g. adjustment for region, site, and time of enrolment).
  * no drop-outs occur, there is no missing data, and at the time of each interim analysis full information is available on all enrolled participants.
  * the trial is perpetual (there is no criteria to completely stop enrolment to the trial).
  * for computational purposes, mean-field variational Bayes is used to approximate posterior densities and posterior quantities are calculated on the basis of 20,000 Monte Carlo draws from this posterior.
  * Summaries of trial operating characteristics are based on 10,000 simulations under each scenario.


## Scenarios

In all scenarios, the simulations assume that the first interim occurs when 400 participants have completed follow-up and subsequent interim analyses occur every additional 200 participants.
For the purposes of simulation, results up to a total trial sample size of 5,000 participants are presented. In all scenarios the baseline probability of response was 0.2 and the reference value for futility was $\ln(1.1)$.

The scenarios considered are summarised in Table \@ref(tab:scetab).

```{r scetab}
tab <- tribble(
  ~ Scenario, ~Description, ~`Effect size (OR)`,
  "Global null", "All interventions in all domains have no effect", "$1.00$",
  "One effective", "One intervention in a domain increases odds", "$1.10$",
  "One effective", "One intervention in a domain reduces odds", "$1/1.10$",
  "One effective", "One intervention in a domain reduces odds", "$1/1.25$",
  "One effective", "One intervention in a domain reduces odds", "$1/1.50$",
  "One effective", "One intervention in a domain reduces odds", "$1/2.00$",
  "Two effective", "Two interventions in a domain increase odds", "$1.10$",
  "Two effective", "Two interventions in a domain reduce odds", "$1/1.10$",
  "Two effective", "Two interventions in a domain reduce odds", "$1/1.25$",
  "Two effective", "Two interventions in a domain reduce odds", "$1/1.50$",
  "Two effective", "Two interventions in a domain reduce odds", "$1/2.00$",
)
kable(tab, booktabs = T, escape = F, linesep = "",
      caption = "Trial simulation scenarios.") %>%
  kable_styling(latex_options = "HOLD_position")
```

\clearpage

# Operating Characteristics

For each scenario we present various operating characteristics.
The focus is on the probability of triggering each decision as the trial progresses, the changing probability of allocation to each treatment, and the probability of response.

## Domain A (6 treatments with one combination)

### Global Null Scenario

The global null scenario for domain A shows a probability of less than 0.2 of dropping the no treatment option (either due to inferiority or a treatment declared effective) by 5,000 participants enrolled.
Each intervention option in the domain has less than 0.05 probability of having been declared effective by 5,000 participants enrolled (approx $0.04$).
The global probability of dropping the standard care arm by 5,000 participants is approximately 0.2.

There is moderate probability of deciding ineffective arms as futile by 5,000 participants enrolled (at least $0.4$ for each ineffective arm).
As the trial progresses, the expected probability of receiving the no treatment option increases due to the probability of dropping active treatments for futility.
Due to the changing allocation probabilities, the no treatment option has the highest median number assigned.
The extra futility check of $A_5$ compared to $A_1$ and $A_2$ results in a high probability of futility for this intervention compared to the others.


```{r}
res0 <- readRDS("~/out_files/ascot/ascot_sims2/null1.rds")
```


```{r, fig.cap="Probability of decision for domain A treatments as trial progresses."}
p <- res0$res_trial %>% 
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -treatment) %>%
  group_by(treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(treatment, key, value, fill = list(n = 0)) %>%
  group_by(treatment, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res0$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("A", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_wrap( ~ fct_inorder(treatment)) +
  geom_line(aes(y = cp, colour = decision)) +
  # scale_colour_viridis_d("Decision") +
  scale_colour_manual("Decision", values = cbp2) +
  labs(x = "Total trial sample size", y = "Probability") +
  ylim(0, NA) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))
p
```



```{r, fig.cap="Expected allocation probability in domain A treatments as trial progresses.", fig.height=3}
res0$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res0$res_trt %>% filter(config == 2) %>% unnest(data)) %>%
  filter(grepl("a", treatment)) %>%
  group_by(interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("A", str_sub(treatment, 2, 2))) %>% 
  ungroup(domain) %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_grid(. ~ domain) +
  # geom_line() +
  geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=3}
p <- res0$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim],
         treatment = paste0("A", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(. ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
```


```{r, fig.cap="Probability of response as trial progresses.", fig.height=3}
res0$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res0$res_trt %>% unnest(data) %>% filter(config == 2)) %>%
  filter(grepl("c", treatment)) %>%
  group_by(interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  # scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event proportion amongst recruited cohort") +
  ylim(0, NA)
```


\clearpage

### One treatment effective

In the following, one treatment in domain $A$ ($A_3$) is effective (or harmful).
The probability of deciding effectiveness exceeds 0.9 by 4,000 participants enrolled when $A_3$ changes the odds of the outcome by a factor of $2/3$ and exceeds 0.9 by 1,600 participants enrolled when $A_3$ changes the odds of the outcome by a factor of $0.5$.

When $A_3$ reduces the odds of the outcome by a factor $0.5$, the probability of declaring superiority by 5,000 participants is 0.9.

Figures \@ref(fig:fig6) and \@ref(fig:fig7) show the expected allocation probabilities and expected outcome probabilities respectively under the varying effect size.

```{r}
res <- readRDS("~/out_files/ascot/ascot_sims2/fin_eff_domA.rds")
res$res_trt %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trt_intrm %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trial %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
```


```{r, fig.cap="Probability of decision for domain A treatments as trial progresses (white facets are the affected treatments).", fig.height=6}
p <- res$res_trial %>%
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -OR, -treatment) %>%
  group_by(OR, treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(OR, treatment, key, value, fill = list(n = 0)) %>%
  group_by(OR, treatment, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("A", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_grid(OR ~ fct_inorder(treatment)) +
  # geom_bar(stat = 'identity') +
  geom_line(aes(y = cp, colour = decision)) +
  scale_colour_manual("Decision", values = cbp2) +
  # scale_colour_viridis_d("Decision") +
  labs(x = "Total trial sample size", y = "Cumulative Probability") +
  ylim(0, NA) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "grey85", "grey85", "white", "grey85", "grey85")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


```{r fig6, fig.cap="Expected allocation probability in domain A treatments as trial progresses. Affected treatments are $A_3$."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("A", str_sub(treatment, 2, 2))) %>% 
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_wrap(~ OR) +
  geom_line() +
  # geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r fig7, fig.cap="Probability of response as trial progresses."}
res$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res$res_trt %>% unnest(data)) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  facet_wrap( ~ OR) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event probability amongst recruited cohort") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=6}
p <- res$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         treatment = paste0("A", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(OR ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  # geom_boxplot(outlier.shape = NA) +
  # geom_violin(scale = "width", adjust = .5, size = 0.2) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "grey85", "grey85", "white", "grey85", "grey85")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


```{r, fig.cap="Expected treatment effect summary.", include=FALSE}
res$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res$res_trt %>% unnest(data)) %>%
  filter(grepl("a[1-9]", treatment)) %>%
  mutate(trt_hdiw = trt_ub - trt_lb) %>%
  select(OR, interim, treatment, trt_mu, trt_lb, trt_ub, trt_eff, trt_bes, trt_fut, trt_hdiw) %>%
  group_by(OR, interim, treatment) %>%
  summarise_all(mean) %>%
  ggplot(., aes(interim, trt_mu)) +
  facet_grid(treatment ~ OR) +
  geom_pointrange(aes(ymin = trt_lb, ymax = trt_ub), size = 0.2) +
  geom_hline(yintercept = 0, linetype = 2)
```


```{r, fig.cap="Distribution of treatment quantities.", include=FALSE}
res$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res$res_trt %>% unnest(data)) %>%
  filter(grepl("a1|a3", treatment)) %>%
  mutate(trt_hdiw = trt_ub - trt_lb) %>%
  select(OR, interim, treatment, trt_eff, trt_bes, trt_fut) %>%
  gather(key, value, -OR, -interim, -treatment) %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         treatment = paste0("A", str_sub(treatment, 2, 2)),
         quantity = factor(key, levels = c("trt_eff", "trt_bes", "trt_fut"),
                           labels = c("Pr(effective)", "Pr(superior)", "Pr(futile)"))) %>%
  group_by(OR, interim, treatment) %>%
  ggplot(., aes(ss, value)) + 
  facet_grid(OR~treatment) + 
  geom_boxplot(aes(fill = quantity, colour = quantity, group=paste(quantity, interim)), outlier.shape = NA) +
  scale_fill_manual(values = cbp2) +
  scale_colour_manual(values = cbp2) +
  labs(x = "Total trial sample size", y = "Probability", fill = "Quantity", colour = "Quantity") +
  theme(legend.position = "top")
```

\clearpage

### Two treatments effective

In the following, two treatments in domain $A$ ($A_3, A_4$) are effective (or harmful).

When the effect size is $1/1.50$ the probability of declaring at least one of $A_3$ or $A_4$ effective exceeds 0.8 by 2,600 participants enrolled and 0.9 by 3,400 participants. 
The probability of dropping at least one of $A_3$ or $A_4$ is 0.08 by 5,000 participants.

When the effect size is $1/2.00$ the probability of declaring at least one effective exceeds 0.9 by 1,400 participants enrolled.
The probability of dropping at least one of $A_3$ or $A_4$ is 0.07 by 5,000 participants.

```{r}
res <- readRDS("~/out_files/ascot/ascot_sims2/fin_2eff_domA.rds")
res$res_trt %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trt_intrm %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trial %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
```


```{r}
p <- res$res_trial %>% 
  unnest(data) %>%
  filter(grepl("a[3|4]", treatment)) %>%
  group_by(trial, OR) %>% 
  select(ends_with("at")) %>%
  ungroup() %>%
  group_by(trial, OR) %>%
  summarise_all(min, na.rm = T) %>%
  gather(key, value, -OR, -trial) %>%
  group_by(OR, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(OR, key, value, fill = list(n = 0)) %>%
  group_by(OR, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) 
```


```{r, fig.cap="Probability of decision for domain A treatments as trial progresses (white facets are the affected treatments).", fig.height=6}
p <- res$res_trial %>% 
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -OR, -treatment) %>%
  group_by(OR, treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(OR, treatment, key, value, fill = list(n = 0)) %>%
  group_by(OR, treatment, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("A", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_grid(OR ~ fct_inorder(treatment)) +
  geom_line(aes(y = cp, colour = decision)) +
  scale_colour_manual("Decision", values = cbp2) +
  labs(x = "Total trial sample size", y = "Cumulative Probability") +
  ylim(0, NA) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "grey85", "grey85", "white", "white", "grey85")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


```{r, fig.cap="Expected allocation probability in domain A treatments as trial progresses. Affected treatments are $A_3, A_4$."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("A", str_sub(treatment, 2, 2))) %>% 
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_wrap(~ OR) +
  geom_line() +
  # geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r, fig.cap="Probability of response as trial progresses. Reference line is response under SoC."}
res$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res$res_trt %>% unnest(data)) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  facet_wrap( ~ OR) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event probability amongst recruited cohort") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=6}
p <- res$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         treatment = paste0("A", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(OR ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "grey85", "grey85", "white", "white", "grey85")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


\clearpage

### One element of a combination treatment effective

In this configuration, treatment $A_1$ is effective and there is no interaction between $A_1$ and $A_2$ so that the combination treatment $A_5=A_1+A_2$ is equally effective to $A_1$ but involves the additional ineffective treatment $A_2$.
In such a situation, preference would be the selection of $A_1$ over $A_5$.

```{r}
res <- readRDS("~/out_files/ascot/ascot_sims2/fin_eff_domA2.rds")
res$res_trt %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trt_intrm %<>% ungroup() %>%
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trial %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
```


```{r, fig.cap="Probability of decision for domain A treatments as trial progresses (white facets are the affected treatments).", fig.height=6}
p <- res$res_trial %>% 
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -OR, -treatment) %>%
  group_by(OR, treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(OR, treatment, key, value, fill = list(n = 0)) %>%
  group_by(OR, treatment, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("A", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_grid(OR ~ fct_inorder(treatment)) +
  geom_line(aes(y = cp, colour = decision)) +
  scale_colour_manual("Decision", values = cbp2) +
  labs(x = "Total trial sample size", y = "Probability") +
  ylim(0, NA) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "white", "grey85", "grey85", "grey85", "white")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


```{r, fig.cap="Expected allocation probability in domain A treatments as trial progresses. Treatments $A_1$ and $A_5$ are equally effective."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("A", str_sub(treatment, 2, 2))) %>% 
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_wrap(~ OR) +
  geom_line() +
  # geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r, fig.cap="Probability of response as trial progresses."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  facet_wrap( ~ OR) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event probability amongst recruited cohort") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=6}
p <- res$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("a", treatment)) %>%
  group_by(OR, treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         treatment = paste0("A", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(OR ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "white", "grey85", "grey85", "grey85", "white")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


\clearpage

## Domain B (4 treatments)

In this scenario a domain of four treatments under the following design is assumed
$$
 X_{B} = 
\begin{blockarray}{ccccc}
          & \beta_{B0} & \beta_{B1} & \beta_{B2} & \beta_{B3} \\
\begin{block}{r(cccc)}
      B_0 & 1 & 0 & 0 & 0 \\
      B_1 & 0 & 1 & 0 & 0 \\
      B_2 & 0 & 0 & 1 & 0 \\
      B_3 & 0 & 0 & 0 & 1 \\
\end{block}
\end{blockarray}
$$

### Global Null Scenario

The global null scenario for domain A shows a probability of less than 0.15 of dropping the no treatment option (either due to inferiority or a treatment declared effective) by 5,000 participants enrolled.
Each intervention option in the domain has less than 0.05 probability of having been declared effective by 5,000 participants enrolled (approx $0.04$).
There is moderate probability of deciding ineffective arms as futile by 5,000 participants enrolled (approximately $0.5$ for each ineffective arm).
As the trial progresses, the expected probability of receiving the no treatment option increases due to the probability of dropping active treatments for futility.
Due to the changing allocation probabilities, the no treatment option has the highest median number assigned.


```{r, fig.cap="Probability of decision for domain B treatments as trial progresses."}
p <- res0$res_trial %>%
  unnest(data) %>%
  filter(grepl("b", treatment)) %>%
  group_by(treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -treatment) %>%
  group_by(treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(treatment, key, value, fill = list(n = 0)) %>%
  group_by(treatment, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res0$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("B", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_wrap( ~ fct_inorder(treatment)) +
  # geom_bar(stat = 'identity') +
  geom_line(aes(y = cp, colour = decision)) +
  scale_colour_manual("Decision", values = cbp2) +
  labs(x = "Total trial sample size", y = "Probability") +
  ylim(0, NA) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))
p
```



```{r, fig.cap="Expected allocation probability in domain B treatments as trial progresses.", fig.height=3}
res0$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res0$res_trt %>% filter(config == 2) %>% unnest(data)) %>%
  filter(grepl("b", treatment)) %>%
  group_by(interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("B", str_sub(treatment, 2, 2))) %>% 
  ungroup(domain) %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_grid(. ~ domain) +
  # geom_line() +
  geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=3}
p <- res0$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("b", treatment)) %>%
  group_by(treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim],
         treatment = paste0("B", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(. ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
```


```{r, fig.cap="Probability of response as trial progresses.", fig.height=3}
res0$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res0$res_trt %>% unnest(data) %>% filter(config == 2)) %>%
  filter(grepl("c", treatment)) %>%
  group_by(interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  # scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event proportion amongst recruited cohort") +
  ylim(0, NA)
```


\clearpage

### One Treatment Effective

In the following, one treatment in domain $B$ ($B_1$) is effective (or harmful).

The probability of deciding effectiveness exceeds 0.9 by 3,000 participants enrolled when $B_1$ changes the odds of the outcome by a factor of $2/3$ and exceeds 0.9 by 1,400 participants enrolled when $B_1$ changes the odds of the outcome by a factor of $0.5$.
When $B_1$ reduces the odds of the outcome by $1/1.25$, the probability of dropping $B_1$ remains below 0.06 by 5,000 participants enrolled. 

When $B_1$ reduces the odds of the outcome by a factor $0.5$, the probability of declaring superiority is 0.9 by 2,200 participants enrolled.

```{r}
res <- readRDS("~/out_files/ascot/ascot_sims2/fin_eff_domB.rds")
res$res_trt %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trt_intrm %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trial %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
```


```{r, fig.cap="Probability of decision for domain B treatments as trial progresses (white facets are the affected treatments).", fig.height=6}
p <- res$res_trial %>% 
  unnest(data) %>%
  filter(grepl("b", treatment)) %>%
  group_by(OR, treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -OR, -treatment) %>%
  group_by(OR, treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(OR, treatment, key, value, fill = list(n = 0)) %>%
  group_by(OR, treatment, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("B", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_grid(OR ~ fct_inorder(treatment)) +
  # geom_bar(stat = 'identity') +
  geom_line(aes(y = cp, colour = decision)) +
  scale_colour_manual("Decision", values = cbp2) +
  labs(x = "Total trial sample size", y = "Probability") +
  ylim(0, NA) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "white", "grey85", "grey85")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


```{r, fig.cap="Expected allocation probability in domain B treatments as trial progresses."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("b", treatment)) %>%
  group_by(OR, interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("B", str_sub(treatment, 2, 2))) %>% 
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_wrap(~ OR) +
  geom_line() +
  # geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r, fig.cap="Probability of response as trial progresses."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  facet_wrap( ~ OR) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event probability amongst recruited cohort") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=6}
p <- res$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("b", treatment)) %>%
  group_by(OR, treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         treatment = paste0("B", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(OR ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "white", "grey85", "grey85")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```

\clearpage

### Two Effective

In the following, two treatments in domain $B$ ($B_1, B_2$) are effective (or harmful).

When the effect size is $1/1.25$, the probability of declaring at least one of $B_1$ or $B_2$ effective is approximately 0.74 by 5,000 participants.

When the effect size is $1/1.50$ the probability of declaring at least one of $B_1$ or $B_2$ effective exceeds 0.8 by 2,200 participants enrolled and 0.9 by 3,000 participants. 
The probability of dropping at least one of $B_1$ or $B_2$ is below 0.08 by 5,000 participants.

When the effect size is $1/2.00$ the probability of declaring at least one effective exceeds 0.9 by 1,200 participants enrolled.
The probability of dropping at least one of $B_1$ or $B_2$ is 0.08 by 5,000 participants.


```{r}
res <- readRDS("~/out_files/ascot/ascot_sims2/fin_2eff_domB.rds")
res$res_trt %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trt_intrm %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trial %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
```


```{r}
p <- res$res_trial %>% 
  unnest(data) %>%
  filter(grepl("b[1|2]", treatment)) %>%
  group_by(trial, OR) %>% 
  select(ends_with("at")) %>%
  ungroup() %>%
  group_by(trial, OR) %>%
  summarise_all(min, na.rm = T) %>%
  gather(key, value, -OR, -trial) %>%
  group_by(OR, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(OR, key, value, fill = list(n = 0)) %>%
  group_by(OR, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) 
```



```{r, fig.cap="Probability of decision for domain B treatments as trial progresses (white facets are the affected treatments).", fig.height=6}
p <- res$res_trial %>% 
  unnest(data) %>%
  filter(grepl("b", treatment)) %>%
  group_by(OR, treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -OR, -treatment) %>%
  group_by(OR, treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(OR, treatment, key, value, fill = list(n = 0)) %>%
  group_by(OR, treatment, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("B", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_grid(OR ~ fct_inorder(treatment)) +
  geom_line(aes(y = cp, colour = decision)) +
  scale_colour_manual("Decision", values = cbp2) +
  labs(x = "Total trial sample size", y = "Probability") +
  ylim(0, NA) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "white", "white", "grey85")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


```{r, fig.cap="Expected allocation probability in domain B treatments as trial progresses."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("b", treatment)) %>%
  group_by(OR, interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("B", str_sub(treatment, 2, 2))) %>% 
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_wrap(~ OR) +
  geom_line() +
  # geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r, fig.cap="Probability of response as trial progresses."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  facet_wrap( ~ OR) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event probability amongst recruited cohort") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=6}
p <- res$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("b", treatment)) %>%
  group_by(OR, treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         treatment = paste0("B", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(OR ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "white", "white", "grey85")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```

\clearpage

## Domain C (2 treatments)

In what follows, a domain of two treatments is considered under the following design
$$
 X_{C} = 
\begin{blockarray}{ccc}
          & \beta_{C0} & \beta_{C1} \\
\begin{block}{r(cc)}
      C_0 & 1 & 0 \\
      C_1 & 0 & 1 \\
\end{block}
\end{blockarray}
$$

### Global Null

The global null scenario for domain C shows a probability of less than 0.06 of dropping the no treatment option (either due to inferiority or a treatment declared effective) by 5,000 participants enrolled.
The lone active intervention option in the domain has less than 0.06 probability of having been declared effective by 5,000 participants enrolled.

There is moderate probability of deciding an ineffective arm as futile by 5,000 participants enrolled (approximately $0.58$).
As the trial progresses, the expected probability of receiving the no treatment option increases due to the probability of dropping active treatments for futility.


```{r, fig.cap="Probability of decision for domain C treatments as trial progresses."}
p <- res0$res_trial %>% 
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -treatment) %>%
  group_by(treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(treatment, key, value, fill = list(n = 0)) %>%
  group_by(treatment, key) %>%
  mutate(p = n / sum(n), tn = sum(n), cn = cumsum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res0$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("C", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_wrap( ~ fct_inorder(treatment)) +
  geom_line(aes(y = cp, colour = decision)) +
  scale_colour_manual("Decision", values = cbp2) +
  labs(x = "Total trial sample size", y = "Probability") +
  scale_y_continuous(breaks = seq(0, 1, 0.1), limit = c(0, NA)) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))
p
```


```{r, fig.cap="Expected allocation probability in domain C treatments as trial progresses.", fig.height=3}
res0$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res0$res_trt %>% filter(config == 2) %>% unnest(data)) %>%
  filter(grepl("c", treatment)) %>%
  group_by(interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("C", str_sub(treatment, 2, 2))) %>% 
  ungroup(domain) %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_grid(. ~ domain) +
  # geom_line() +
  geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=3}
p <- res0$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim],
         treatment = paste0("B", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(. ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
```


```{r, fig.cap="Probability of response as trial progresses.", fig.height=3}
res0$res_trt_intrm %>%
  unnest(data) %>%
  bind_rows(res0$res_trt %>% unnest(data) %>% filter(config == 2)) %>%
  filter(grepl("c", treatment)) %>%
  group_by(interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res0$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  # scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event proportion amongst recruited cohort") +
  ylim(0, NA)
```


\clearpage

### One Effective Treatment

In the following, the one active treatment in domain $C$ ($C_1$) is effective (or harmful).

The probability of deciding effectiveness/superiority exceeds 0.9 by 2,200 participants enrolled when $C_1$ changes the odds of the outcome by a factor of $2/3$ and exceeds 0.9 by 800 participants enrolled when $C_1$ changes the odds of the outcome by a factor of $0.5$.
When $C_1$ reduces the odds of the outcome by $1/1.25$, the probability of dropping $C_1$ remains below 0.04 by 5,000 participants enrolled. 


```{r}
res <- readRDS("~/out_files/ascot/ascot_sims2/fin_eff_domC.rds")
res$res_trt %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trt_intrm %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
res$res_trial %<>% ungroup() %>% 
  mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50','2.00'))))
```



```{r, fig.cap="Probability of decision for domain C treatments as trial progresses (white facets are the affected treatments).", fig.height=5}
p <- res$res_trial %>% 
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, treatment) %>% 
  select(ends_with("at")) %>%
  gather(key, value, -OR, -treatment) %>%
  group_by(OR, treatment, key) %>%
  count(value) %>% 
  ungroup() %>%
  complete(OR, treatment, key, value, fill = list(n = 0)) %>%
  group_by(OR, treatment, key) %>%
  mutate(p = n / sum(n), cp = cumsum(p)) %>%
  ungroup() %>%
  filter(!is.na(value)) %>%
  mutate(
    ss = res$cfg$n_seq[[1]][value],
    domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
    treatment = paste0("C", str_sub(treatment, 2, 2)),
    decision = factor(
      key,
      levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at", 
                 "trig_fut_at", "trig_equ_at", "trig_drop_at"),
      labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>% 
  ggplot(., aes(ss, p)) +
  facet_grid(OR ~ fct_inorder(treatment)) +
  geom_line(aes(y = cp, colour = decision)) +
  scale_colour_manual("Decision", values = cbp2) +
  labs(x = "Total trial sample size", y = "Probability") +
  ylim(0, NA) +
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "white")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


```{r, fig.cap="Expected allocation probability in domain C treatments as trial progresses."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, interim, treatment) %>%
  summarise(p = mean(p_rand_trt)) %>%
  mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))),
         treatment = paste0("C", str_sub(treatment, 2, 2))) %>% 
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         ref = 1/length(unique(treatment))) %>%
  ggplot(., aes(ss, p, group = treatment, colour = treatment)) +
  facet_wrap(~ OR) +
  geom_line() +
  # geom_smooth(se = F, size = 0.5, method = 'loess') +
  geom_hline(aes(yintercept = ref), linetype = 2) +
  scale_colour_manual("Treatment", values = cbp2) +
  labs(x = "Total trial sample size", y = "Expected allocation probability",
       colour = "Treatment") +
  theme(legend.position = "top") +
  ylim(0, NA)
```


```{r, fig.cap="Probability of response as trial progresses."}
res$res_trt_intrm %>%
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, interim, trial) %>%
  summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim]) %>%
  ggplot(., aes(ss, p, group = ss)) +
  facet_wrap( ~ OR) +
  geom_violin() +
  geom_hline(yintercept = 0.2, linetype = 2) +
  scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) +
  labs(x = "Total trial sample size", y = "Event probability amongst recruited cohort") +
  ylim(0, NA)
```


```{r, fig.cap="Number assigned to each treatment.", fig.height=6}
p <- res$res_trt_intrm %>% 
  unnest(data) %>%
  filter(grepl("c", treatment)) %>%
  group_by(OR, treatment, interim) %>% 
  select(n_agg_enr_trt) %>%
  summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>%
  ungroup() %>%
  mutate(ss = res$cfg$n_seq[[1]][interim],
         treatment = paste0("C", str_sub(treatment, 2, 2))) %>%
  ggplot(., aes(ss, n_agg_enr_trt, group = ss)) +
  facet_grid(OR ~ treatment) +
  geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) +
  labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g <- ggplot_gtable(ggplot_build(p))
stript <- which(grepl('strip-t', g$layout$name))
fills <- c("grey85", "white")
k <- 1
for (i in stript) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
grid::grid.draw(g)
```


\clearpage

<!-- ## Domain B (3 treatments) -->

<!-- In this scenario a domain of three treatments under the following design is assumed -->
<!-- $$ -->
<!--  X_{B} =  -->
<!-- \begin{blockarray}{cccc} -->
<!--           & \beta_{B0} & \beta_{B1} & \beta_{B2} \\ -->
<!-- \begin{block}{r(ccc)} -->
<!--       B_0 & 1 & 0 & 0 \\ -->
<!--       B_1 & 0 & 1 & 0 \\ -->
<!--       B_2 & 0 & 1 & 1 \\ -->
<!-- \end{block} -->
<!-- \end{blockarray} -->
<!-- $$ -->

<!-- ### Global Null -->

<!-- ```{r} -->
<!-- res0 <- readRDS("~/out_files/ascot/ascot_sims4/null.rds") -->
<!-- ``` -->


<!-- ```{r, fig.cap="Probability of decision for domain B treatments as trial progresses."} -->
<!-- p <- res0$res_trial %>% -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(treatment) %>%  -->
<!--   select(ends_with("at")) %>% -->
<!--   gather(key, value, -treatment) %>% -->
<!--   group_by(treatment, key) %>% -->
<!--   count(value) %>%  -->
<!--   ungroup() %>% -->
<!--   complete(treatment, key, value, fill = list(n = 0)) %>% -->
<!--   group_by(treatment, key) %>% -->
<!--   mutate(p = n / sum(n), cp = cumsum(p)) %>% -->
<!--   ungroup() %>% -->
<!--   filter(!is.na(value)) %>% -->
<!--   mutate( -->
<!--     ss = res0$cfg$n_seq[[1]][value], -->
<!--     domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))), -->
<!--     treatment = paste0("B", str_sub(treatment, 2, 2)), -->
<!--     decision = factor( -->
<!--       key, -->
<!--       levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at",  -->
<!--                  "trig_fut_at", "trig_equ_at", "trig_drop_at"), -->
<!--       labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>%  -->
<!--   ggplot(., aes(ss, p)) + -->
<!--   facet_wrap( ~ fct_inorder(treatment)) + -->
<!--   # geom_bar(stat = 'identity') + -->
<!--   geom_line(aes(y = cp, colour = decision)) + -->
<!--   scale_colour_manual("Decision", values = cbp2) + -->
<!--   labs(x = "Total trial sample size", y = "Probability") + -->
<!--   ylim(0, NA) + -->
<!--   theme(legend.position = "top", -->
<!--         axis.text.x = element_text(angle = 45, hjust = 1)) -->
<!-- p -->
<!-- ``` -->



<!-- ```{r, fig.cap="Expected allocation probability in domain B treatments as trial progresses.", fig.height=3} -->
<!-- res0$res_trt_intrm %>% -->
<!--   unnest(data) %>% -->
<!--   bind_rows(res0$res_trt %>% filter(config == 2) %>% unnest(data)) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(interim, treatment) %>% -->
<!--   summarise(p = mean(p_rand_trt)) %>% -->
<!--   mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))), -->
<!--          treatment = paste0("B", str_sub(treatment, 2, 2))) %>%  -->
<!--   ungroup(domain) %>% -->
<!--   mutate(ss = res0$cfg$n_seq[[1]][interim], -->
<!--          ref = 1/length(unique(treatment))) %>% -->
<!--   ggplot(., aes(ss, p, group = treatment, colour = treatment)) + -->
<!--   facet_grid(. ~ domain) + -->
<!--   # geom_line() + -->
<!--   geom_smooth(se = F, size = 0.5, method = 'loess') + -->
<!--   geom_hline(aes(yintercept = ref), linetype = 2) + -->
<!--   scale_colour_manual("Treatment", values = cbp2) + -->
<!--   labs(x = "Total trial sample size", y = "Expected allocation probability", -->
<!--        colour = "Treatment") + -->
<!--   theme(legend.position = "top") + -->
<!--   ylim(0, NA) -->
<!-- ``` -->


<!-- ```{r, fig.cap="Number assigned to each treatment.", fig.height=3} -->
<!-- p <- res0$res_trt_intrm %>%  -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(treatment, interim) %>%  -->
<!--   select(n_agg_enr_trt) %>% -->
<!--   summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(ss = res0$cfg$n_seq[[1]][interim], -->
<!--          treatment = paste0("B", str_sub(treatment, 2, 2))) %>% -->
<!--   ggplot(., aes(ss, n_agg_enr_trt, group = ss)) + -->
<!--   facet_grid(. ~ treatment) + -->
<!--   geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) + -->
<!--   labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") + -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 1)) -->
<!-- p -->
<!-- ``` -->


<!-- ```{r, fig.cap="Probability of response as trial progresses.", fig.height=3} -->
<!-- res0$res_trt_intrm %>% -->
<!--   unnest(data) %>% -->
<!--   bind_rows(res0$res_trt %>% unnest(data) %>% filter(config == 2)) %>% -->
<!--   filter(grepl("c", treatment)) %>% -->
<!--   group_by(interim, trial) %>% -->
<!--   summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(ss = res0$cfg$n_seq[[1]][interim]) %>% -->
<!--   ggplot(., aes(ss, p, group = ss)) + -->
<!--   geom_violin() + -->
<!--   geom_hline(yintercept = 0.2, linetype = 2) + -->
<!--   # scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) + -->
<!--   labs(x = "Total trial sample size", y = "Event proportion amongst recruited cohort") + -->
<!--   ylim(0, NA) -->
<!-- ``` -->

<!-- \clearpage -->

<!-- ### One treatment effective in combination -->


<!-- ```{r} -->
<!-- res <- readRDS("~/out_files/ascot/ascot_sims4/fin_eff_domB2.rds") -->
<!-- res$res_trt %<>% ungroup() %>%  -->
<!--   mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50')))) -->
<!-- res$res_trt_intrm %<>% ungroup() %>%  -->
<!--   mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50')))) -->
<!-- res$res_trial %<>% ungroup() %>%  -->
<!--   mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50')))) -->
<!-- ``` -->


<!-- ```{r, fig.cap="Probability of decision for domain B treatments as trial progresses (white facets are the affected treatments).", fig.height=6} -->
<!-- p <- res$res_trial %>%  -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(OR, treatment) %>%  -->
<!--   select(ends_with("at")) %>% -->
<!--   gather(key, value, -OR, -treatment) %>% -->
<!--   group_by(OR, treatment, key) %>% -->
<!--   count(value) %>%  -->
<!--   ungroup() %>% -->
<!--   complete(OR, treatment, key, value, fill = list(n = 0)) %>% -->
<!--   group_by(OR, treatment, key) %>% -->
<!--   mutate(p = n / sum(n), cp = cumsum(p)) %>% -->
<!--   ungroup() %>% -->
<!--   filter(!is.na(value)) %>% -->
<!--   mutate( -->
<!--     ss = res$cfg$n_seq[[1]][value], -->
<!--     domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))), -->
<!--     treatment = paste0("B", str_sub(treatment, 2, 2)), -->
<!--     decision = factor( -->
<!--       key, -->
<!--       levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at",  -->
<!--                  "trig_fut_at", "trig_equ_at", "trig_drop_at"), -->
<!--       labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>%  -->
<!--   ggplot(., aes(ss, p)) + -->
<!--   facet_grid(OR ~ fct_inorder(treatment)) + -->
<!--   # geom_bar(stat = 'identity') + -->
<!--   geom_line(aes(y = cp, colour = decision)) + -->
<!--   scale_colour_manual("Decision", values = cbp2) + -->
<!--   labs(x = "Total trial sample size", y = "Probability") + -->
<!--   ylim(0, NA) + -->
<!--   theme(legend.position = "top", -->
<!--         axis.text.x = element_text(angle = 45, hjust = 1)) -->

<!-- g <- ggplot_gtable(ggplot_build(p)) -->
<!-- stript <- which(grepl('strip-t', g$layout$name)) -->
<!-- fills <- c("grey85", "grey85", "white", "grey85") -->
<!-- k <- 1 -->
<!-- for (i in stript) { -->
<!--   j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)) -->
<!--   g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k] -->
<!--   k <- k+1 -->
<!-- } -->
<!-- grid::grid.draw(g) -->
<!-- ``` -->



<!-- ```{r, fig.cap="Expected allocation probability in domain B treatments as trial progresses."} -->
<!-- res$res_trt_intrm %>% -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(OR, interim, treatment) %>% -->
<!--   summarise(p = mean(p_rand_trt)) %>% -->
<!--   mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))), -->
<!--          treatment = paste0("B", str_sub(treatment, 2, 2))) %>%  -->
<!--   ungroup() %>% -->
<!--   mutate(ss = res$cfg$n_seq[[1]][interim], -->
<!--          ref = 1/length(unique(treatment))) %>% -->
<!--   ggplot(., aes(ss, p, group = treatment, colour = treatment)) + -->
<!--   facet_wrap(~ OR) + -->
<!--   geom_line() + -->
<!--   # geom_smooth(se = F, size = 0.5, method = 'loess') + -->
<!--   geom_hline(aes(yintercept = ref), linetype = 2) + -->
<!--   scale_colour_manual("Treatment", values = cbp2) + -->
<!--   labs(x = "Total trial sample size", y = "Expected allocation probability", -->
<!--        colour = "Treatment") + -->
<!--   theme(legend.position = "top") + -->
<!--   ylim(0, NA) -->
<!-- ``` -->


<!-- ```{r, fig.cap="Probability of response as trial progresses."} -->
<!-- res$res_trt_intrm %>% -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("c", treatment)) %>% -->
<!--   group_by(OR, interim, trial) %>% -->
<!--   summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(ss = res$cfg$n_seq[[1]][interim]) %>% -->
<!--   ggplot(., aes(ss, p, group = ss)) + -->
<!--   facet_wrap( ~ OR) + -->
<!--   geom_violin() + -->
<!--   geom_hline(yintercept = 0.2, linetype = 2) + -->
<!--   scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) + -->
<!--   labs(x = "Total trial sample size", y = "Event probability amongst recruited cohort") + -->
<!--   ylim(0, NA) -->
<!-- ``` -->


<!-- ```{r, fig.cap="Number assigned to each treatment.", fig.height=6} -->
<!-- p <- res$res_trt_intrm %>%  -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(OR, treatment, interim) %>%  -->
<!--   select(n_agg_enr_trt) %>% -->
<!--   summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(ss = res$cfg$n_seq[[1]][interim], -->
<!--          treatment = paste0("B", str_sub(treatment, 2, 2))) %>% -->
<!--   ggplot(., aes(ss, n_agg_enr_trt, group = ss)) + -->
<!--   facet_grid(OR ~ treatment) + -->
<!--   geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) + -->
<!--   labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") + -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 1)) -->

<!-- g <- ggplot_gtable(ggplot_build(p)) -->
<!-- stript <- which(grepl('strip-t', g$layout$name)) -->
<!-- fills <- c("grey85", "white", "grey85", "grey85") -->
<!-- k <- 1 -->
<!-- for (i in stript) { -->
<!--   j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)) -->
<!--   g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k] -->
<!--   k <- k+1 -->
<!-- } -->
<!-- grid::grid.draw(g) -->
<!-- ``` -->

<!-- \clearpage -->

<!-- ### One treatment effective alone and in combination -->

<!-- ```{r} -->
<!-- res <- readRDS("~/out_files/ascot/ascot_sims4/fin_eff_domB.rds") -->
<!-- res$res_trt %<>% ungroup() %>%  -->
<!--   mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50')))) -->
<!-- res$res_trt_intrm %<>% ungroup() %>%  -->
<!--   mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50')))) -->
<!-- res$res_trial %<>% ungroup() %>%  -->
<!--   mutate(OR = c("1.10", paste0("1/", c('1.10','1.25','1.50')))) -->
<!-- ``` -->


<!-- ```{r, fig.cap="Probability of decision for domain B treatments as trial progresses (white facets are the affected treatments).", fig.height=6} -->
<!-- p <- res$res_trial %>%  -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(OR, treatment) %>%  -->
<!--   select(ends_with("at")) %>% -->
<!--   gather(key, value, -OR, -treatment) %>% -->
<!--   group_by(OR, treatment, key) %>% -->
<!--   count(value) %>%  -->
<!--   ungroup() %>% -->
<!--   complete(OR, treatment, key, value, fill = list(n = 0)) %>% -->
<!--   group_by(OR, treatment, key) %>% -->
<!--   mutate(p = n / sum(n), cp = cumsum(p)) %>% -->
<!--   ungroup() %>% -->
<!--   filter(!is.na(value)) %>% -->
<!--   mutate( -->
<!--     ss = res$cfg$n_seq[[1]][value], -->
<!--     domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))), -->
<!--     treatment = paste0("B", str_sub(treatment, 2, 2)), -->
<!--     decision = factor( -->
<!--       key, -->
<!--       levels = c("trig_eff_at", "trig_sup_at", "trig_ineff_at", "trig_inf_at",  -->
<!--                  "trig_fut_at", "trig_equ_at", "trig_drop_at"), -->
<!--       labels = c("Effective", "Superior", "Harmful", "Inferior", "Futile", "Equivalent", "Drop"))) %>%  -->
<!--   ggplot(., aes(ss, p)) + -->
<!--   facet_grid(OR ~ fct_inorder(treatment)) + -->
<!--   # geom_bar(stat = 'identity') + -->
<!--   geom_line(aes(y = cp, colour = decision)) + -->
<!--   scale_colour_manual("Decision", values = cbp2) + -->
<!--   labs(x = "Total trial sample size", y = "Probability") + -->
<!--   ylim(0, NA) + -->
<!--   theme(legend.position = "top", -->
<!--         axis.text.x = element_text(angle = 45, hjust = 1)) -->

<!-- g <- ggplot_gtable(ggplot_build(p)) -->
<!-- stript <- which(grepl('strip-t', g$layout$name)) -->
<!-- fills <- c("grey85", "white", "white", "grey85") -->
<!-- k <- 1 -->
<!-- for (i in stript) { -->
<!--   j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)) -->
<!--   g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k] -->
<!--   k <- k+1 -->
<!-- } -->
<!-- grid::grid.draw(g) -->
<!-- ``` -->



<!-- ```{r, fig.cap="Expected allocation probability in domain B treatments as trial progresses."} -->
<!-- res$res_trt_intrm %>% -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(OR, interim, treatment) %>% -->
<!--   summarise(p = mean(p_rand_trt)) %>% -->
<!--   mutate(domain = paste("Domain:", toupper(str_sub(treatment, 1, 1))), -->
<!--          treatment = paste0("B", str_sub(treatment, 2, 2))) %>%  -->
<!--   ungroup() %>% -->
<!--   mutate(ss = res$cfg$n_seq[[1]][interim], -->
<!--          ref = 1/length(unique(treatment))) %>% -->
<!--   ggplot(., aes(ss, p, group = treatment, colour = treatment)) + -->
<!--   facet_wrap(~ OR) + -->
<!--   geom_line() + -->
<!--   # geom_smooth(se = F, size = 0.5, method = 'loess') + -->
<!--   geom_hline(aes(yintercept = ref), linetype = 2) + -->
<!--   scale_colour_manual("Treatment", values = cbp2) + -->
<!--   labs(x = "Total trial sample size", y = "Expected allocation probability", -->
<!--        colour = "Treatment") + -->
<!--   theme(legend.position = "top") + -->
<!--   ylim(0, NA) -->
<!-- ``` -->


<!-- ```{r, fig.cap="Probability of response as trial progresses."} -->
<!-- res$res_trt_intrm %>% -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("c", treatment)) %>% -->
<!--   group_by(OR, interim, trial) %>% -->
<!--   summarise(p = sum(y_agg_enr_trt) / sum(n_agg_enr_trt)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(ss = res$cfg$n_seq[[1]][interim]) %>% -->
<!--   ggplot(., aes(ss, p, group = ss)) + -->
<!--   facet_wrap( ~ OR) + -->
<!--   geom_violin() + -->
<!--   geom_hline(yintercept = 0.2, linetype = 2) + -->
<!--   scale_colour_discrete(labels = exp(-sapply(res$cfg$b, `[`, 2))) + -->
<!--   labs(x = "Total trial sample size", y = "Event probability amongst recruited cohort") + -->
<!--   ylim(0, NA) -->
<!-- ``` -->


<!-- ```{r, fig.cap="Number assigned to each treatment.", fig.height=6} -->
<!-- p <- res$res_trt_intrm %>%  -->
<!--   unnest(data) %>% -->
<!--   filter(grepl("b", treatment)) %>% -->
<!--   group_by(OR, treatment, interim) %>%  -->
<!--   select(n_agg_enr_trt) %>% -->
<!--   summarise(m = mean(n_agg_enr_trt), med = median(n_agg_enr_trt), lb = quantile(n_agg_enr_trt, 0.25), ub = quantile(n_agg_enr_trt, 0.75)) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(ss = res$cfg$n_seq[[1]][interim], -->
<!--          treatment = paste0("B", str_sub(treatment, 2, 2))) %>% -->
<!--   ggplot(., aes(ss, n_agg_enr_trt, group = ss)) + -->
<!--   facet_grid(OR ~ treatment) + -->
<!--   geom_pointrange(aes(y = med, ymin = lb, ymax = ub), size = 0.15) + -->
<!--   labs(x = "Sample size", y = "Number assigned to treatment (median and IQR)") + -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 1)) -->

<!-- g <- ggplot_gtable(ggplot_build(p)) -->
<!-- stript <- which(grepl('strip-t', g$layout$name)) -->
<!-- fills <- c("grey85", "white", "grey85", "grey85") -->
<!-- k <- 1 -->
<!-- for (i in stript) { -->
<!--   j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder)) -->
<!--   g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k] -->
<!--   k <- k+1 -->
<!-- } -->
<!-- grid::grid.draw(g) -->
<!-- ``` -->
